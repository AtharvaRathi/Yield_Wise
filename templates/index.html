<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Crop Advisor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1>üåæ Smart Crop Advisor</h1>
            <p>Data-driven yield predictions with AI-powered farming insights.</p>
        </header>

        <main>
            <div class="card" id="input-card">
                <form id="crop-form">
                    <div class="grid-container">
                        <div class="form-group">
                            <label for="crop">Crop</label>
                            <select id="crop">
                                <option>Rice</option><option>Wheat</option><option>Maize</option>
                                <option>Cotton</option><option>Sugarcane</option><option>Groundnut</option>
                                <option>Bajra</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="season">Season</label>
                            <select id="season">
                                <option>Kharif</option><option>Rabi</option>
                                <option>Summer</option><option>Whole Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <select id="state">
                                <option>Andhra Pradesh</option><option>Karnataka</option><option>Tamil Nadu</option>
                                <option>Kerala</option><option>Maharashtra</option><option>Punjab</option>
                                <option>Haryana</option><option>Gujarat</option><option>Rajasthan</option>
                                <option>West Bengal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-container number-inputs">
                        <div class="form-group">
                            <label for="area">üìè Area (hectares)</label>
                            <input type="number" id="area" value="100" min="10" step="10">
                        </div>
                        <div class="form-group">
                            <label for="rainfall">üåßÔ∏è Rainfall (mm)</label>
                            <input type="number" id="rainfall" value="1200" min="300" step="50">
                        </div>
                        <div class="form-group">
                            <label for="fertilizer">üß™ Fertilizer (kg/ha)</label>
                            <input type="number" id="fertilizer" value="75" min="20" step="5">
                        </div>
                        <div class="form-group">
                            <label for="pesticide">üõ°Ô∏è Pesticide (kg/ha)</label>
                            <input type="number" id="pesticide" value="20" min="5" step="2">
                        </div>
                    </div>
                    
                    <button type="submit" id="predict-btn">
                        <span>Analyze & Predict</span>
                    </button>
                </form>
            </div>

            <div id="results-container" class="hidden">
                <div class="card" id="prediction-card">
                    <h3>Yield Prediction</h3>
                    <div class="prediction-main">
                        <div class="yield-value"><span id="predicted-yield">--</span> tons/ha</div>
                        <div class="yield-details">
                            <p><strong>Confidence Range:</strong> <span id="confidence-interval">--</span></p>
                            <p><strong>Total Production:</strong> <span id="total-production">--</span> tons</p>
                        </div>
                    </div>
                </div>

                <div id="recommendations-section" class="hidden">
                    </div>
                 <div id="ai-disabled-note" class="card warning-box hidden">
                    <p>ü§ñ AI recommendations are not available. Ensure the server is configured with a valid Gemini API key.</p>
                </div>

                <div id="error-box" class="card error-box hidden">
                    <h3>An Error Occurred</h3>
                    <p id="error-message"></p>
                </div>
            </div>

            <div id="loader" class="loader-container hidden">
                <div class="loader"></div>
                <p>Analyzing data and consulting AI...</p>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('crop-form');
            const predictBtn = document.getElementById('predict-btn');
            const resultsContainer = document.getElementById('results-container');
            const loader = document.getElementById('loader');
            const errorBox = document.getElementById('error-box');
            const aiDisabledNote = document.getElementById('ai-disabled-note');
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                loader.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
                errorBox.classList.add('hidden');
                aiDisabledNote.classList.add('hidden');
                predictBtn.disabled = true;
                
                const formData = {
                    crop: document.getElementById('crop').value,
                    season: document.getElementById('season').value,
                    state: document.getElementById('state').value,
                    area: document.getElementById('area').value,
                    rainfall: document.getElementById('rainfall').value,
                    fertilizer: document.getElementById('fertilizer').value,
                    pesticide: document.getElementById('pesticide').value,
                };

                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData),
                    });
                    
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'An unknown server error occurred.');
                    }
                    
                    displayResults(data);

                } catch (err) {
                    displayError(err.message);
                } finally {
                    loader.classList.add('hidden');
                    predictBtn.disabled = false;
                }
            });

            function displayResults(data) {
                resultsContainer.classList.remove('hidden');
                document.getElementById('prediction-card').classList.remove('hidden');

                document.getElementById('predicted-yield').textContent = data.predicted_yield;
                document.getElementById('confidence-interval').textContent = `${data.confidence_interval[0]} - ${data.confidence_interval[1]} tons/ha`;
                document.getElementById('total-production').textContent = `${data.total_production}`;

                const recSection = document.getElementById('recommendations-section');
                recSection.innerHTML = '<h3>ü§ñ AI-Powered Recommendations</h3>';
                
                if (data.recommendations && !data.recommendations.error) {
                    recSection.classList.remove('hidden');
                    let delay = 0;
                    for (const [key, value] of Object.entries(data.recommendations)) {
                        const card = createRecommendationCard(key, value);
                        card.style.animationDelay = `${delay}s`;
                        recSection.appendChild(card);
                        delay += 0.1;
                    }
                } else {
                    recSection.classList.add('hidden');
                    aiDisabledNote.classList.remove('hidden');
                    if (data.recommendations && data.recommendations.error) {
                        console.error("AI Error:", data.recommendations.error);
                    }
                }
            }
            
            function createRecommendationCard(title, details) {
                const card = document.createElement('div');
                card.className = 'card recommendation-card';
                
                const formattedTitle = title.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                let content = `<h4>${formattedTitle}</h4><ul>`;
                
                if (typeof details === 'object') {
                    for (const [key, value] of Object.entries(details)) {
                        const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        content += `<li><strong>${formattedKey}:</strong> ${value}</li>`;
                    }
                } else {
                    content += `<li>${details}</li>`;
                }

                content += '</ul>';
                card.innerHTML = content;
                return card;
            }

            function displayError(message) {
                resultsContainer.classList.remove('hidden');
                document.getElementById('prediction-card').classList.add('hidden');
                document.getElementById('recommendations-section').classList.add('hidden');
                errorBox.classList.remove('hidden');
                document.getElementById('error-message').textContent = message;
            }
        });
    </script>
</body>
</html>