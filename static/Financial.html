<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Finance Calculator</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Styles -->
    <style>
        /* Replicating the YieldWise Design System */
        :root {
            --color-background: #fcfcf9;
            --color-surface: #ffffff;
            --color-primary: #21808d;
            --color-primary-hover: #1a6974;
            --color-text: #13343b;
            --color-text-secondary: #626c71;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-card-border: rgba(94, 82, 64, 0.12);
            --color-focus-ring: rgba(33, 128, 141, 0.4);
            --color-success: #16a34a; /* Green */
            --color-loss: #dc2626;  /* Red */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 3px var(--color-focus-ring);
        }
        
        .result-list-item {
            display: flex;
            flex-direction: column;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--color-card-border);
        }
        .result-list-item:last-child { border-bottom: none; }

        .result-item-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-list-item-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--color-text-secondary);
        }
        .result-list-item-value {
            font-weight: 600;
            color: var(--color-text);
        }
        .result-justification {
            font-size: 0.75rem; /* 12px */
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
            padding-left: 2.25rem; /* Aligns with the label text */
            font-style: italic;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-4xl p-4 sm:p-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[#13343b]">🌾 Crop Finance Calculator</h1>
            <p class="text-lg text-[#626c71] mt-2">Get a transparent financial breakdown powered by AI market analysis.</p>
        </header>

        <!-- Input Card -->
        <div class="bg-white rounded-xl border border-[rgba(94,82,64,0.12)] shadow-sm p-6 sm:p-8">
            <h3 class="text-lg font-semibold text-[#13343b] mb-6">Enter Farming Details</h3>
            <form id="finance-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group">
                        <label for="crop-name" class="block text-sm font-semibold mb-2 text-[#626c71]">Crop Name</label>
                        <input type="text" id="crop-name" required class="w-full p-2 border border-[rgba(94,82,64,0.2)] rounded-lg transition" placeholder="e.g., Wheat">
                    </div>
                    <div class="form-group">
                        <label for="area" class="block text-sm font-semibold mb-2 text-[#626c71]">Area of Land (in Acres)</label>
                        <input type="number" id="area" required class="w-full p-2 border border-[rgba(94,82,64,0.2)] rounded-lg transition" placeholder="e.g., 5" min="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="state" class="block text-sm font-semibold mb-2 text-[#626c71]">State</label>
                        <input type="text" id="state" required class="w-full p-2 border border-[rgba(94,82,64,0.2)] rounded-lg transition" placeholder="e.g., Punjab">
                    </div>
                </div>
                <div class="mt-6">
                    <button type="submit" id="calculate-btn" class="w-full bg-[#21808d] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#1a6974] transition-all duration-200 transform hover:-translate-y-0.5 shadow-md">
                        Generate Financial Report
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center p-8 hidden">
             <div class="flex justify-center items-center space-x-2">
                <div class="w-4 h-4 rounded-full bg-teal-600 animate-bounce [animation-delay:-0.3s]"></div>
                <div class="w-4 h-4 rounded-full bg-teal-600 animate-bounce [animation-delay:-0.15s]"></div>
                <div class="w-4 h-4 rounded-full bg-teal-600 animate-bounce"></div>
            </div>
            <p class="mt-4 text-[#626c71]">AI is analyzing market data and generating your report...</p>
        </div>

        <!-- Results Card -->
        <div id="results-card" class="bg-white rounded-xl border border-[rgba(94,82,64,0.12)] shadow-sm p-6 sm:p-8 mt-8 hidden">
            <!-- Results content will be injected here -->
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const financeForm = document.getElementById('finance-form');
            const calculateBtn = document.getElementById('calculate-btn');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsCard = document.getElementById('results-card');
            
            // Chart instances to be able to destroy them before redrawing
            let expenditureChartInstance;
            let profitLossChartInstance;

            financeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const cropName = document.getElementById('crop-name').value;
                const area = document.getElementById('area').value;
                const state = document.getElementById('state').value;

                if (!cropName || !area || !state) {
                    alert('Please fill in all fields.');
                    return;
                }

                loadingIndicator.classList.remove('hidden');
                resultsCard.classList.add('hidden');
                calculateBtn.disabled = true;
                calculateBtn.textContent = 'Generating...';

                try {
                    const financialData = await getFinancialAnalysis(cropName, area, state);
                    displayResults(financialData, area);
                } catch (error) {
                    console.error('Error fetching financial analysis:', error);
                    resultsCard.innerHTML = `<div class="text-center p-4">
                        <h3 class="text-lg font-bold text-red-600">Calculation Failed</h3>
                        <p class="text-[#626c71] mt-2">${error.message}</p>
                        <p class="text-sm text-gray-500 mt-2">The AI model could not generate a report. Please try again or refine your inputs.</p>
                    </div>`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                    resultsCard.classList.remove('hidden');
                    resultsCard.classList.add('fade-in');
                    calculateBtn.disabled = false;
                    calculateBtn.textContent = 'Generate Financial Report';
                }
            });

            async function getFinancialAnalysis(crop, area, state) {
                const apiKey = "GEMINI_API_KEY"; // Leave empty
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const systemPrompt = `You are an expert agricultural financial advisor for the Indian market. Your task is to provide a detailed and realistic financial breakdown for a farmer. You MUST base your calculations on recent, publicly available market data, including government Minimum Support Prices (MSP) where applicable for the specified crop and state. You must provide your response ONLY as a valid JSON object. Do not include any text or explanations outside of the JSON. All currency values must be in Indian Rupees (INR). For each cost and revenue item, you MUST provide a brief justification for the value you chose.`;
                const userQuery = `Calculate the financial breakdown for growing ${crop} on ${area} acres of land in ${state}, India for the current year.`;

                const schema = {
                    type: "OBJECT",
                    properties: {
                        estimated_costs: {
                            type: "OBJECT",
                            properties: {
                                seeds: { type: "OBJECT", properties: { total_cost: { type: "NUMBER" }, justification: { type: "STRING" } } },
                                fertilizer: { type: "OBJECT", properties: { total_cost: { type: "NUMBER" }, justification: { type: "STRING" } } },
                                pesticides_herbicides: { type: "OBJECT", properties: { total_cost: { type: "NUMBER" }, justification: { type: "STRING" } } },
                                labor: { type: "OBJECT", properties: { total_cost: { type: "NUMBER" }, justification: { type: "STRING" } } },
                                machinery_fuel: { type: "OBJECT", properties: { total_cost: { type: "NUMBER" }, justification: { type: "STRING" } } },
                                irrigation: { type: "OBJECT", properties: { total_cost: { type: "NUMBER" }, justification: { type: "STRING" } } },
                                miscellaneous: { type: "OBJECT", properties: { total_cost: { type: "NUMBER" }, justification: { type: "STRING" } } },
                            }
                        },
                        total_expenditure: { type: "NUMBER" },
                        market_analysis: {
                            type: "OBJECT",
                            properties: {
                                average_yield_per_acre: { type: "STRING" },
                                average_market_price: { type: "STRING" },
                                estimated_revenue: { type: "NUMBER" },
                                justification: { type: "STRING", description: "Justification for the revenue estimate, citing MSP or market rates." }
                            }
                        },
                        profit_analysis: {
                            type: "OBJECT",
                            properties: {
                                potential_profit: { type: "NUMBER" },
                                return_on_investment: { type: "STRING" }
                            }
                        },
                        summary: { type: "STRING" }
                    },
                    required: ["estimated_costs", "total_expenditure", "market_analysis", "profit_analysis", "summary"]
                };

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        temperature: 0, 
                        responseMimeType: "application/json",
                        responseSchema: schema,
                    },
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(errorBody.error?.message || `API request failed with status ${response.status}`);
                }
                
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText);
            }

            function formatCurrency(value) {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(value);
            }

            function displayResults(data, area) {
                const { estimated_costs, total_expenditure, market_analysis, profit_analysis, summary } = data;
                
                let resultsHTML = `
                    <h2 class="text-2xl font-bold text-center text-[#13343b] mb-2">Financial Analysis Report</h2>
                    <p class="text-center text-[#626c71] mb-6">For ${area} acres of ${document.getElementById('crop-name').value} in ${document.getElementById('state').value}</p>
                    
                    <!-- NEW: Dashboard Section -->
                    <div class="mt-8 mb-8">
                        <h3 class="text-lg font-semibold text-[#13343b] mb-4">📈 Financial Dashboard</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center bg-gray-50 p-4 rounded-lg">
                            <div class="w-full max-w-xs mx-auto">
                                <h4 class="text-center text-sm font-semibold text-gray-600 mb-2">Expenditure Breakdown</h4>
                                <canvas id="expenditureChart"></canvas>
                            </div>
                            <div class="w-full">
                                <h4 class="text-center text-sm font-semibold text-gray-600 mb-2">Revenue vs. Expenditure</h4>
                                <canvas id="profitLossChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Estimated Expenditure Section -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-[#13343b] mb-4">📊 Estimated Expenditure</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="result-list-item"><div class="result-item-main"><span class="result-list-item-label">🌱 Seeds</span><span class="result-list-item-value">${formatCurrency(estimated_costs.seeds.total_cost)}</span></div><p class="result-justification">${estimated_costs.seeds.justification}</p></div>
                            <div class="result-list-item"><div class="result-item-main"><span class="result-list-item-label">🌿 Fertilizer</span><span class="result-list-item-value">${formatCurrency(estimated_costs.fertilizer.total_cost)}</span></div><p class="result-justification">${estimated_costs.fertilizer.justification}</p></div>
                            <div class="result-list-item"><div class="result-item-main"><span class="result-list-item-label">🐞 Pesticides & Herbicides</span><span class="result-list-item-value">${formatCurrency(estimated_costs.pesticides_herbicides.total_cost)}</span></div><p class="result-justification">${estimated_costs.pesticides_herbicides.justification}</p></div>
                            <div class="result-list-item"><div class="result-item-main"><span class="result-list-item-label">💧 Irrigation</span><span class="result-list-item-value">${formatCurrency(estimated_costs.irrigation.total_cost)}</span></div><p class="result-justification">${estimated_costs.irrigation.justification}</p></div>
                            <div class="result-list-item"><div class="result-item-main"><span class="result-list-item-label">👨‍🌾 Labor</span><span class="result-list-item-value">${formatCurrency(estimated_costs.labor.total_cost)}</span></div><p class="result-justification">${estimated_costs.labor.justification}</p></div>
                            <div class="result-list-item"><div class="result-item-main"><span class="result-list-item-label">🚜 Machinery & Fuel</span><span class="result-list-item-value">${formatCurrency(estimated_costs.machinery_fuel.total_cost)}</span></div><p class="result-justification">${estimated_costs.machinery_fuel.justification}</p></div>
                            <div class="result-list-item"><div class="result-item-main"><span class="result-list-item-label">📦 Miscellaneous</span><span class="result-list-item-value">${formatCurrency(estimated_costs.miscellaneous.total_cost)}</span></div><p class="result-justification">${estimated_costs.miscellaneous.justification}</p></div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-[#21808d] text-white rounded-b-lg -mt-1">
                            <span class="font-bold text-lg">Total Estimated Expenditure</span>
                            <span class="font-bold text-xl">${formatCurrency(total_expenditure)}</span>
                        </div>
                    </div>
                    <!-- Revenue & Profit Analysis Section -->
                    <div>
                         <h3 class="text-lg font-semibold text-[#13343b] mb-4">💰 Revenue & Profit Analysis</h3>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-[#626c71]">Avg. Yield / Acre</p><p class="text-xl font-bold text-[#13343b]">${market_analysis.average_yield_per_acre}</p></div>
                            <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-[#626c71]">Avg. Market Price</p><p class="text-xl font-bold text-[#13343b]">${market_analysis.average_market_price}</p></div>
                            <div class="bg-gray-50 p-4 rounded-lg"><p class="text-sm text-[#626c71]">Estimated Revenue</p><p class="text-xl font-bold text-[#13343b]">${formatCurrency(market_analysis.estimated_revenue)}</p></div>
                         </div>
                         <p class="text-xs text-center text-gray-500 italic mt-3">${market_analysis.justification}</p>
                    </div>
                    <!-- Final Profit/Loss -->
                    <div class="mt-6 p-6 rounded-lg text-center ${profit_analysis.potential_profit > 0 ? 'bg-green-100' : 'bg-red-100'}">
                        <p class="text-lg ${profit_analysis.potential_profit > 0 ? 'text-green-800' : 'text-red-800'}">${profit_analysis.potential_profit > 0 ? 'Potential Profit' : 'Potential Loss'}</p>
                        <p class="text-4xl font-bold ${profit_analysis.potential_profit > 0 ? 'text-[var(--color-success)]' : 'text-[var(--color-loss)]'} my-2">${formatCurrency(Math.abs(profit_analysis.potential_profit))}</p>
                        <p class="font-semibold text-gray-600">Return on Investment (ROI): ${profit_analysis.return_on_investment}</p>
                    </div>
                     <!-- Summary -->
                     <div class="mt-6 text-center border-t border-dashed pt-4">
                        <p class="text-sm text-[#626c71] italic">"${summary}"</p>
                     </div>
                `;
                resultsCard.innerHTML = resultsHTML;

                // Create charts after the HTML is rendered
                createExpenditureChart(estimated_costs);
                createProfitLossChart(total_expenditure, market_analysis.estimated_revenue);
            }

            function createExpenditureChart(costs) {
                if (expenditureChartInstance) {
                    expenditureChartInstance.destroy();
                }
                const ctx = document.getElementById('expenditureChart').getContext('2d');
                const labels = Object.keys(costs).map(key => key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()));
                const data = Object.values(costs).map(item => item.total_cost);

                expenditureChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Expenditure',
                            data: data,
                            backgroundColor: ['#21808d', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#6f42c1'],
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    },
                });
            }

            function createProfitLossChart(expenditure, revenue) {
                 if (profitLossChartInstance) {
                    profitLossChartInstance.destroy();
                }
                const ctx = document.getElementById('profitLossChart').getContext('2d');
                
                profitLossChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Financial Overview'],
                        datasets: [
                            {
                                label: 'Total Expenditure',
                                data: [expenditure],
                                backgroundColor: 'rgba(220, 38, 38, 0.6)', // Red for loss/cost
                                borderColor: 'rgba(220, 38, 38, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Estimated Revenue',
                                data: [revenue],
                                backgroundColor: 'rgba(22, 163, 74, 0.6)', // Green for success/profit
                                borderColor: 'rgba(22, 163, 74, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                         scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value, index, values) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                             tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

        });
    </script>

</body>
</html>

